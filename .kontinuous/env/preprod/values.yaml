strapi:
  strategyType: Recreate
  ~needs: [build-strapi, pg-strapi]
  env:
    - name: DATABASE_NAME
      valueFrom:
        secretKeyRef:
          key: PGDATABASE
          name: pg-strapi-app
    - name: DATABASE_HOST
      valueFrom:
        secretKeyRef:
          key: host
          name: pg-strapi-superuser
    - name: DATABASE_PASSWORD
      valueFrom:
        secretKeyRef:
          key: password
          name: pg-strapi-superuser
    - name: DATABASE_PORT
      valueFrom:
        secretKeyRef:
          key: port
          name: pg-strapi-superuser
    - name: DATABASE_USERNAME
      valueFrom:
        secretKeyRef:
          key: user
          name: pg-strapi-superuser

n8n:
  ~needs: [build-n8n, pg-n8n]
  env:
    - name: DB_POSTGRESDB_DATABASE
      valueFrom:
        secretKeyRef:
          key: PGDATABASE
          name: pg-n8n-app
    - name: DB_POSTGRESDB_HOST
      valueFrom:
        secretKeyRef:
          key: host
          name: pg-n8n-superuser
    - name: DB_POSTGRESDB_PASSWORD
      valueFrom:
        secretKeyRef:
          key: password
          name: pg-n8n-superuser
    - name: DB_POSTGRESDB_PORT
      valueFrom:
        secretKeyRef:
          key: port
          name: pg-n8n-superuser
    - name: DB_POSTGRESDB_USER
      valueFrom:
        secretKeyRef:
          key: user
          name: pg-n8n-superuser
    - name: PG_DATABASE
      valueFrom:
        secretKeyRef:
          key: PGDATABASE
          name: pg-app
    - name: PG_HOST
      valueFrom:
        secretKeyRef:
          key: host
          name: pg-superuser
    - name: PG_PASSWORD
      valueFrom:
        secretKeyRef:
          key: password
          name: pg-superuser
    - name: PG_PORT
      valueFrom:
        secretKeyRef:
          key: port
          name: pg-superuser
    - name: PG_USERNAME
      valueFrom:
        secretKeyRef:
          key: user
          name: pg-superuser

server:
  ~needs: [build-server, pg]
  env:
    - name: PG_DB
      valueFrom:
        secretKeyRef:
          key: PGDATABASE
          name: pg-app
    - name: PG_HOST
      valueFrom:
        secretKeyRef:
          key: host
          name: pg-superuser
    - name: PG_PASSWORD
      valueFrom:
        secretKeyRef:
          key: password
          name: pg-superuser
    - name: PG_PORT
      valueFrom:
        secretKeyRef:
          key: port
          name: pg-superuser
    - name: PG_USER
      valueFrom:
        secretKeyRef:
          key: user
          name: pg-superuser
    - name: PG_SSL_SELF_SIGNED
      value: "true"

pg:
  ~chart: pg
  cnpg-cluster:
    backup:
      ~tpl~enabled: "false"

pg-n8n:
  ~chart: pg
  cnpg-cluster:
    backup:
      ~tpl~enabled: "false"

pg-strapi:
  ~chart: pg
  cnpg-cluster:
    backup:
      ~tpl~enabled: "false"

pgadmin:
  ~chart: app
  ~needs: ["build-pgadmin"]
  imagePackage: pgadmin
  env:
    - name: POSTGRES_USER
      valueFrom:
        secretKeyRef:
          name: pg-app
          key: PGUSER
    - name: POSTGRES_PASSWORD
      valueFrom:
        secretKeyRef:
          name: pg-app
          key: PGPASSWORD
    - name: POSTGRES_HOST
      valueFrom:
        secretKeyRef:
          name: pg-app
          key: PGHOST
    - name: POSTGRES_PORT
      valueFrom:
        secretKeyRef:
          name: pg-app
          key: PGPORT
    - name: POSTGRES_USER_2
      valueFrom:
        secretKeyRef:
          name: pg-n8n
          key: PGUSER
    - name: POSTGRES_PASSWORD_2
      valueFrom:
        secretKeyRef:
          name: pg-n8n
          key: PGPASSWORD
    - name: POSTGRES_HOST_2
      valueFrom:
        secretKeyRef:
          name: pg-n8n
          key: PGHOST
    - name: POSTGRES_PORT_2
      valueFrom:
        secretKeyRef:
          name: pg-n8n
          key: PGPORT
    - name: POSTGRES_USER_3
      valueFrom:
        secretKeyRef:
          name: pg-strapi
          key: PGUSER
    - name: POSTGRES_PASSWORD_3
      valueFrom:
        secretKeyRef:
          name: pg-strapi
          key: PGPASSWORD
    - name: POSTGRES_HOST_3
      valueFrom:
        secretKeyRef:
          name: pg-strapi
          key: PGHOST
    - name: POSTGRES_PORT_3
      valueFrom:
        secretKeyRef:
          name: pg-strapi
          key: PGPORT

jobs:
  ~chart: jobs
  runs:
    build-pgadmin:
      use: build
      with:
        imagePackage: pgadmin
        context: src/pgadmin
