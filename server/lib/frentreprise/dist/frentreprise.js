!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("frentreprise",[],t):"object"==typeof exports?exports.frentreprise=t():e.frentreprise=t()}(global,function(){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:a})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r.w={},r(r.s=11)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e};const n=Symbol("_importData"),s=Symbol("_data");t.default=class{constructor(e={}){this[n](e,!0)}updateData(e){this[n](e)}replaceData(e){this[n](e,!0)}[n](e,t=!1){"object"==typeof e&&(this[s]=a({},!0===t?{}:this[s],e)),Object.keys(this[s]).forEach(e=>{this.hasOwnProperty(e)||Object.defineProperty(this,e,{get:()=>this[s][e]})},this)}};t._protected={_importData:n}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Etablissement=t.Entreprise=void 0;var a=r(5);Object.defineProperty(t,"Entreprise",{enumerable:!0,get:function(){return i(a).default}});var n=r(4);Object.defineProperty(t,"Etablissement",{enumerable:!0,get:function(){return i(n).default}});var s=i(a);function i(e){return e&&e.__esModule?e:{default:e}}t.default=s.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,n=r(6),s=(a=n)&&a.__esModule?a:{default:a};function i(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function a(n,s){try{var i=t[n](s),o=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(o).then(function(e){a("next",e)},function(e){a("throw",e)});e(o)}("next")})}}t.default=class{getSIRET(){return i(function*(){throw new s.default})()}getSIREN(){return i(function*(){throw new s.default})()}search(){return i(function*(){throw new s.default})()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateSIREN=function(e){if(!/^[0-9]{9}$/.test(e))return!1;return e.split("").reduce((e,t,r)=>{t=+t;const a=r%2==0;return a?e+t:e+((t*=2)>9?t-9:t)},0)%10==0},t.validateSIRET=function(e){if(!/^[0-9]{14}$/.test(e))return!1;return e.split("").reduce((e,t,r)=>{t=+t;const a=r%2!=0;return a?e+t:e+((t*=2)>9?t-9:t)},0)%10==0}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},s=r(0),i=(a=s)&&a.__esModule?a:{default:a};const o=Symbol("_entreprise");t.default=class extends i.default{constructor(e,t){super(),this[o]=t,this.replaceData(e)}[s._protected._importData](e){if(this[o]){const t=e&&e._etData;t&&"object"==typeof t&&(this[o].updateData(t),this[o].updateData({_dataSources:n({},this[o]._dataSources,e._dataSources)}),delete e._etData)}super[s._protected._importData](e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(0),n=o(a),s=o(r(1)),i=r(3);function o(e){return e&&e.__esModule?e:{default:e}}const c=Symbol("_ets"),u=Symbol("_etsModel");t.default=class extends n.default{constructor(e,t=s.default){super(),this[c]=[],this[u]=t,this.replaceData(e)}[a._protected._importData](e,t){const r=e&&e._ets;r&&(Array.isArray(r)||(r=[r]),r.forEach(e=>{e&&"object"==typeof e&&(0,i.validateSIRET)(e.siret)&&this.getEtablissement(e.siret).updateData(e)}),delete e._ets),super[a._protected._importData](e,t)}get etablissements(){return this[c]}hasEtablissement(e){return!!this.getEtablissement(e,!1)}getEtablissement(e,t=!0){return this[c].find(t=>t.siret===e)||t&&this[c].push(new this[u]({siret:e},this))&&this.getEtablissement(e)||null}}},function(e,t,r){"use strict";function a(e){const t=(new Error).stack.split("\n")[2].replace(" at ","");this.message=`The method ${t} isn't implemented.`,e&&(this.message+=` Message: "${e}".`);let r=this.message;for(;r.indexOf("  ")>-1;)r=r.replace("  "," ");this.message=r}Object.defineProperty(t,"__esModule",{value:!0}),a.prototype=Object.create(Error.prototype,{constructor:{value:a},name:{value:"NotImplementedError"},stack:{get:function(){return(new Error).stack}}}),t.default=a},function(e,t){e.exports=require("axios")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=s(r(7)),n=s(r(2));function s(e){return e&&e.__esModule?e:{default:e}}function i(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function a(n,s){try{var i=t[n](s),o=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(o).then(function(e){a("next",e)},function(e){a("throw",e)});e(o)}("next")})}}const o=Symbol("_getAPIParams"),c=Symbol("_convertDate"),u=Symbol("_getCleanAddress");t.default=class extends n.default{constructor(e){super(),this.token=null,this.axios=a.default.create({baseURL:e,timeout:3e4})}getSIRET(e){var t=this;return i(function*(){let r=null;try{r=yield t.axios.get(`etablissements_legacy/${e}`,{params:t[o](t)})}catch(e){console.error(e)}const a={};if(r&&"object"==typeof r&&r.data&&"object"==typeof r.data&&r.data.etablissement){const e=r.data.etablissement;["siret","siege_social","enseigne","nom_commercial","nom","prenom","siret_siege_social"].forEach(function(t){"boolean"==typeof e[t]?a[t]=e[t]:a[t]=e[t]||void 0}),e.etat_administratif&&"object"==typeof e.etat_administratif||(e.etat_administratif={}),a.etat_etablissement={label:e.etat_administratif_etablissement.value||"N/A",date:t[c](e.etat_administratif_etablissement.date_mise_a_jour)}}let n=null;try{n=yield t.axios.get(`etablissements/${e}`,{params:t[o](t)})}catch(e){console.log(e)}if(n&&"object"==typeof n&&n.data&&"object"==typeof n.data&&n.data.etablissement){const e=n.data.etablissement;[].forEach(function(t){a[t]=e[t]}),a.date_creation=t[c](e.date_creation_etablissement),e.adresse&&"object"==typeof e.adresse&&(a.adresse=t[u](e.adresse),a.adresse_components=e.adresse,a.departement="string"==typeof e.adresse.code_insee_localite&&e.adresse.code_insee_localite.length>1&&e.adresse.code_insee_localite.substr(0,2)),a.region=e.region_implementation&&e.region_implementation.value||void 0,a.activite=e.naf&&e.libelle_naf?`${e.naf} - ${e.libelle_naf}`:null,a.etablissement_employeur=+e.tranche_effectif_salarie_etablissement.a>0,a.tranche_effectif_insee=e.tranche_effectif_salarie_etablissement.intitule,a.annee_tranche_effectif_insee=+e.tranche_effectif_salarie_etablissement.date_reference||void 0}let s=null;try{s=yield t.axios.get(`attestations_agefiph/${e}`,{params:t[o](t)})}catch(e){console.log(e)}s&&"object"==typeof s&&s.data&&"object"==typeof s.data&&(a.agefiph_derniere_annee_conformite_connue=s.data.derniere_annee_de_conformite_connue||null);let i=null;try{i=yield t.axios.get(`exercices/${e}`,{params:t[o](t)})}catch(e){console.log(e)}return i&&"object"==typeof i&&i.data&&"object"==typeof i.data&&i.data.exercices&&Array.isArray(i.data.exercices)&&(a.donnees_ecofi={},i.data.exercices.forEach(function(e){a.donnees_ecofi[t[c](e.date_fin_exercice_timestamp).toISOString()]=+e.ca||null})),a})()}getSIREN(e){var t=this;return i(function*(){let r=null;try{r=yield t.axios.get(`entreprises_legacy/${e}`,{params:t[o](t)})}catch(e){console.log(e)}const a={};if(r&&"object"==typeof r&&r.data&&"object"==typeof r.data&&r.data.entreprise){const e=r.data.entreprise;["siren","raison_sociale","nombre_etablissements_actifs","nom_commercial","nom","prenom","siret_siege_social"].forEach(function(t){"boolean"==typeof e[t]?a[t]=e[t]:a[t]=e[t]||void 0}),a.categorie_juridique=e.forme_juridique,a.date_de_creation=t[c](e.date_creation),a.date_de_radiation=t[c](e.date_radiation),e.etat_administratif&&"object"==typeof e.etat_administratif||(e.etat_administratif={}),a.etat_entreprise={label:e.etat_administratif.value||"N/A",date:t[c](e.etat_administratif.date_mise_a_jour)}}let n=null;try{n=yield t.axios.get(`entreprises/${e}`,{params:t[o](t)})}catch(e){console.log(e)}if(n&&"object"==typeof n&&n.data&&"object"==typeof n.data&&n.data.entreprise){const e=n.data.entreprise;["categorie_entreprise"].forEach(function(t){a[t]=e[t]}),e.tranche_effectif_salarie_entreprise&&"object"==typeof e.tranche_effectif_salarie_entreprise&&(a.annee_tranche_effectif=+e.tranche_effectif_salarie_entreprise.date_reference||void 0,a.tranche_effectif=e.tranche_effectif_salarie_entreprise.intitule||void 0),Array.isArray(e.mandataires_sociaux)&&(a.mandataires_sociaux=[],e.mandataires_sociaux.forEach(function(e){a.mandataires_sociaux.push({nom:e.nom,prenom:e.prenom,fonction:e.fonction,raison_sociale:e.raison_sociale})}))}return a})()}[c](e){return e&&new Date(1e3*e)||void 0}[u](e){return`\n    ${e.numero_voie||""} ${e.type_voie||""} ${e.nom_voie||""}\n    ${e.complement_adresse||""} ${e.code_postal||""}\n    ${e.localite||""}\n    `.trim().split("\n").map(e=>e.trim()).join("\n")}[o](){return{token:this.token,context:"Tiers",recipient:"Direccte Occitanie",object:"FCEE - Direccte Occitanie"}}search(){return i(function*(){return!1})()}}},function(e,t,r){"use strict";function a(e){this.message=`Invalid SIRET or SIREN. ${e}`}Object.defineProperty(t,"__esModule",{value:!0}),a.prototype=Object.create(Error.prototype,{constructor:{value:a},name:{value:"InvalidIdentifierError"},stack:{get:function(){return(new Error).stack}}}),t.default=a},function(e,t,r){"use strict";var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},n=u(r(9)),s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(3)),i=u(r(8)),o=u(r(2)),c=r(1);function u(e){return e&&e.__esModule?e:{default:e}}function l(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function a(n,s){try{var i=t[n](s),o=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(o).then(function(e){a("next",e)},function(e){a("throw",e)});e(o)}("next")})}}const f=Symbol("_dataSources"),d=Symbol("_cleanObject");e.exports=new class{constructor(){this.EntrepriseModel=c.Entreprise,this.EtablissementModel=c.Etablissement,this[f]=[],this.addDataSource({name:"ApiGouv",priority:100,source:new i.default("https://entreprise.api.gouv.fr/v2/")})}getEntreprise(e){var t=this;return l(function*(){e+="";const r=s.validateSIREN(e),i=s.validateSIRET(e);if(!r&&!i)throw new n.default(e);const o=r?e:e.substr(0,9),c=t.getDataSources(),u=new t.EntrepriseModel({_dataSources:{}},t.EtablissementModel);for(let e=0;e<c.length;e++){const r=yield c[e].source.getSIREN(o),n=t[d](r);u.updateData(n),u.updateData({_dataSources:a({},u._dataSources,{[c[e].name]:!0})})}const l=i?e:""+u.siret_siege_social;if(s.validateSIRET(l)){let e={_dataSources:{}};for(let r=0;r<c.length;r++){const n=c[r].source;(e=a({},e,t[d](yield n.getSIRET(l))))._dataSources[c[r].name]=!0}u.getEtablissement(e.siret).updateData(e)}return u})()}search(e){var t=this;return l(function*(){const r=t.getDataSources(),n={};for(let i=0;i<r.length;i++){const o=r[i].source,c=r[i].name,u=yield o.search(e);!1!==u?Array.isArray(u)?u.forEach(function(e){const r=s.validateSIREN(e.siren)&&e.siren||e.siret.substr(0,9),i=s.validateSIRET(e.siret)&&e.siret;s.validateSIREN(r)&&(n[r]||(n[r]={siren:r,_dataSources:{}}),i?(Array.isArray(n[r].etablissements)||(n[r].etablissements={}),n[r].etablissements[i]=a({},n[r].etablissements[i]||{_dataSources:{}},t[d](e)),n[r].etablissements[i]._dataSources[c]=!0):(Array.isArray(e.etablissements)&&(e.etablissements=e.etablissements.reduce(function(e,t){s.validateSIRET(t.siret)&&(e[t.siret]=t)},{})),n[r].etablissements||(n[r].etablissements={}),Object.keys(e.etablissements||{}).forEach(function(s){n[r].etablissements[s]=a({},n[r].etablissements[s]||{_dataSources:{}},t[d](e.etablissements[s])),n[r].etablissements[s]._dataSources[c]=!0}),delete e.etablissements,n[r]=a({},n[r],t[d](e)),n[r]._dataSources[c]=!0))}):console.error(`Source named ${c} returned invalid data for search, array expected. Received:`,u):console.log(`Source named ${c} doesn't support search. (it returned false)`)}return Object.values(n).map(function(e){const r=Object.values(e.etablissements);delete e.etablissements;const a=new t.EntrepriseModel(e,t.EtablissementModel);return r.forEach(function(e){a.getEtablissement(e).updateData(e)}),a})})()}[d](e){return Object.keys(e||{}).forEach(t=>{null!==e[t]&&void 0!==e[t]||delete e[t]}),e}getDataSources(){return[...this[f]].sort((e,t)=>(e=+(e&&e.priority))>(t=+(t&&t.priority))?1:e<t?-1:0)}getDataSource(e){return this[f].find(t=>t.name===e)}addDataSource(e){this[f].includes(e)||this[f].push(e)}removeDataSource(e){this[f].slice(this[f].indexOf(e),1)}},e.exports.Entreprise=c.Entreprise,e.exports.Etablissement=c.Etablissement,e.exports.DataSource=o.default,e.exports.isSIRET=s.validateSIRET,e.exports.isSIREN=s.validateSIREN},function(e,t,r){e.exports=r(10)}])});