!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("frentreprise",[],t):"object"==typeof exports?exports.frentreprise=t():e.frentreprise=t()}(global,function(){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:a})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r.w={},r(r.s=12)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(1);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}})}),t.cleanObject=function(e){return Object.keys(e||{}).forEach(t=>{null!==e[t]&&void 0!==e[t]||delete e[t]}),e}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateSIREN=function(e){if(!/^[0-9]{9}$/.test(e))return!1;return e.split("").reduce((e,t,r)=>{t=+t;const a=r%2==0;return a?e+t:e+((t*=2)>9?t-9:t)},0)%10==0},t.validateSIRET=function(e){if(!/^[0-9]{14}$/.test(e))return!1;return e.split("").reduce((e,t,r)=>{t=+t;const a=r%2!=0;return a?e+t:e+((t*=2)>9?t-9:t)},0)%10==0}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e};const n=Symbol("_importData"),o=Symbol("_data");t.default=class{constructor(e={}){this[n](e,!0)}updateData(e){this[n](e)}replaceData(e){this[n](e,!0)}[n](e,t=!1){"object"==typeof e&&(this[o]=a({},!0===t?{}:this[o],e)),Object.keys(this[o]).forEach(e=>{this.hasOwnProperty(e)||Object.defineProperty(this,e,{get:()=>this[o][e]})},this)}};t._protected={_importData:n}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Etablissement=t.Entreprise=void 0;var a=r(6);Object.defineProperty(t,"Entreprise",{enumerable:!0,get:function(){return i(a).default}});var n=r(5);Object.defineProperty(t,"Etablissement",{enumerable:!0,get:function(){return i(n).default}});var o=i(a);function i(e){return e&&e.__esModule?e:{default:e}}t.default=o.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,n=r(7),o=(a=n)&&a.__esModule?a:{default:a};function i(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function a(n,o){try{var i=t[n](o),s=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(s).then(function(e){a("next",e)},function(e){a("throw",e)});e(s)}("next")})}}t.default=class{getSIRET(){return i(function*(){throw new o.default})()}getSIREN(){return i(function*(){throw new o.default})()}search(){return i(function*(){throw new o.default})()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},o=r(2),i=(a=o)&&a.__esModule?a:{default:a},s=r(0);const c=Symbol("_entreprise");t.default=class extends i.default{constructor(e,t){super(),this[c]=t,this.replaceData(e)}[o._protected._importData](e){if(this[c]){const t=e&&e._etData;t&&"object"==typeof t&&(this[c].updateData((0,s.cleanObject)(t)),this[c].updateData({_dataSources:n({},this[c]._dataSources,e._dataSources)}),delete e._etData)}super[o._protected._importData](e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(2),n=c(a),o=c(r(3)),i=r(1),s=r(0);function c(e){return e&&e.__esModule?e:{default:e}}const u=Symbol("_ets"),l=Symbol("_etsModel");t.default=class extends n.default{constructor(e,t=o.default){super(),this[u]=[],this[l]=t,this.replaceData(e)}[a._protected._importData](e,t){const r=e&&e._ets;r&&(Array.isArray(r)||(r=[r]),r.forEach(e=>{e&&"object"==typeof e&&(0,i.validateSIRET)(e.siret)&&this.getEtablissement(e.siret).updateData((0,s.cleanObject)(e))}),delete e._ets),super[a._protected._importData](e,t)}get etablissements(){return this[u]}hasEtablissement(e){return!!this.getEtablissement(e,!1)}getEtablissement(e,t=!0){return this[u].find(t=>t.siret===e)||t&&this[u].push(new this[l]({siret:e},this))&&this.getEtablissement(e)||null}}},function(e,t,r){"use strict";function a(e){const t=(new Error).stack.split("\n")[2].replace(" at ","");this.message=`The method ${t} isn't implemented.`,e&&(this.message+=` Message: "${e}".`);let r=this.message;for(;r.indexOf("  ")>-1;)r=r.replace("  "," ");this.message=r}Object.defineProperty(t,"__esModule",{value:!0}),a.prototype=Object.create(Error.prototype,{constructor:{value:a},name:{value:"NotImplementedError"},stack:{get:function(){return(new Error).stack}}}),t.default=a},function(e,t){e.exports=require("axios")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=o(r(8)),n=o(r(4));function o(e){return e&&e.__esModule?e:{default:e}}function i(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function a(n,o){try{var i=t[n](o),s=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(s).then(function(e){a("next",e)},function(e){a("throw",e)});e(s)}("next")})}}const s=Symbol("_getAPIParams"),c=Symbol("_convertDate"),u=Symbol("_getCleanAddress");t.default=class extends n.default{constructor(e){super(),this.token=null,this.axios=a.default.create({baseURL:e,timeout:3e4})}getSIRET(e){var t=this;return i(function*(){let r=null;try{r=yield t.axios.get(`etablissements_legacy/${e}`,{params:t[s](t)})}catch(e){console.error(e)}const a={};if(r&&"object"==typeof r&&r.data&&"object"==typeof r.data&&r.data.etablissement){const e=r.data.etablissement;["siret","siege_social","enseigne","nom_commercial","nom","prenom","siret_siege_social"].forEach(function(t){"boolean"==typeof e[t]?a[t]=e[t]:a[t]=e[t]||void 0}),e.etat_administratif&&"object"==typeof e.etat_administratif||(e.etat_administratif={}),a.etat_etablissement={label:e.etat_administratif_etablissement.value||"N/A",date:t[c](e.etat_administratif_etablissement.date_mise_a_jour)}}let n=null;try{n=yield t.axios.get(`etablissements/${e}`,{params:t[s](t)})}catch(e){console.log(e)}if(n&&"object"==typeof n&&n.data&&"object"==typeof n.data&&n.data.etablissement){const e=n.data.etablissement;[].forEach(function(t){a[t]=e[t]}),a.date_creation=t[c](e.date_creation_etablissement),e.adresse&&"object"==typeof e.adresse&&(a.adresse=t[u](e.adresse),a.adresse_components=e.adresse,a.departement="string"==typeof e.adresse.code_insee_localite&&e.adresse.code_insee_localite.length>1&&e.adresse.code_insee_localite.substr(0,2)),a.code_region=e.region_implantation&&+e.region_implantation.code||0,a.region=e.region_implantation&&e.region_implantation.value||void 0,a.activite=e.naf&&e.libelle_naf?`${e.naf} - ${e.libelle_naf}`:null,a.etablissement_employeur=+e.tranche_effectif_salarie_etablissement.a>0,a.tranche_effectif_insee=e.tranche_effectif_salarie_etablissement.intitule,a.annee_tranche_effectif_insee=+e.tranche_effectif_salarie_etablissement.date_reference||void 0}let o=null;try{o=yield t.axios.get(`attestations_agefiph/${e}`,{params:t[s](t)})}catch(e){console.log(e)}o&&"object"==typeof o&&o.data&&"object"==typeof o.data&&(a.agefiph_derniere_annee_conformite_connue=o.data.derniere_annee_de_conformite_connue||null);let i=null;try{i=yield t.axios.get(`exercices/${e}`,{params:t[s](t)})}catch(e){console.log(e)}return i&&"object"==typeof i&&i.data&&"object"==typeof i.data&&i.data.exercices&&Array.isArray(i.data.exercices)&&(a.donnees_ecofi={},i.data.exercices.forEach(function(e){a.donnees_ecofi[t[c](e.date_fin_exercice_timestamp).toISOString()]=+e.ca||null})),a})()}getSIREN(e){var t=this;return i(function*(){let r=null;try{r=yield t.axios.get(`entreprises_legacy/${e}`,{params:t[s](t)})}catch(e){console.log(e)}const a={};if(r&&"object"==typeof r&&r.data&&"object"==typeof r.data&&r.data.entreprise){const e=r.data.entreprise;["siren","raison_sociale","nombre_etablissements_actifs","nom_commercial","nom","prenom","siret_siege_social"].forEach(function(t){"boolean"==typeof e[t]?a[t]=e[t]:a[t]=e[t]||void 0}),a.categorie_juridique=e.forme_juridique,a.date_de_creation=t[c](e.date_creation),a.date_de_radiation=t[c](e.date_radiation),e.etat_administratif&&"object"==typeof e.etat_administratif||(e.etat_administratif={}),a.etat_entreprise={label:e.etat_administratif.value||"N/A",date:t[c](e.etat_administratif.date_mise_a_jour)}}let n=null;try{n=yield t.axios.get(`entreprises/${e}`,{params:t[s](t)})}catch(e){console.log(e)}if(n&&"object"==typeof n&&n.data&&"object"==typeof n.data&&n.data.entreprise){const e=n.data.entreprise;["categorie_entreprise"].forEach(function(t){a[t]=e[t]}),e.tranche_effectif_salarie_entreprise&&"object"==typeof e.tranche_effectif_salarie_entreprise&&(a.annee_tranche_effectif=+e.tranche_effectif_salarie_entreprise.date_reference||void 0,a.tranche_effectif=e.tranche_effectif_salarie_entreprise.intitule||void 0),Array.isArray(e.mandataires_sociaux)&&(a.mandataires_sociaux=[],e.mandataires_sociaux.forEach(function(e){a.mandataires_sociaux.push({nom:e.nom,prenom:e.prenom,fonction:e.fonction,raison_sociale:e.raison_sociale})}))}return a})()}[c](e){return e&&new Date(1e3*e)||void 0}[u](e){return`\n    ${e.numero_voie||""} ${e.type_voie||""} ${e.nom_voie||""}\n    ${e.complement_adresse||""} ${e.code_postal||""}\n    ${e.localite||""}\n    `.trim().split("\n").map(e=>e.trim()).join("\n")}[s](){return{token:this.token,context:"Tiers",recipient:"Direccte Occitanie",object:"FCEE - Direccte Occitanie"}}search(){return i(function*(){return!1})()}}},function(e,t,r){"use strict";function a(e){this.message=`Invalid SIRET or SIREN. ${e}`}Object.defineProperty(t,"__esModule",{value:!0}),a.prototype=Object.create(Error.prototype,{constructor:{value:a},name:{value:"InvalidIdentifierError"},stack:{get:function(){return(new Error).stack}}}),t.default=a},function(e,t,r){"use strict";var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},n=l(r(10)),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(1)),i=l(r(9)),s=l(r(4)),c=r(3),u=r(0);function l(e){return e&&e.__esModule?e:{default:e}}function d(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function a(n,o){try{var i=t[n](o),s=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(s).then(function(e){a("next",e)},function(e){a("throw",e)});e(s)}("next")})}}const f=Symbol("_dataSources");e.exports=new class{constructor(){this.EntrepriseModel=c.Entreprise,this.EtablissementModel=c.Etablissement,this[f]=[],this.addDataSource({name:"ApiGouv",priority:100,source:new i.default("https://entreprise.api.gouv.fr/v2/")})}getEntreprise(e){var t=this;return d(function*(){e+="";const r=o.validateSIREN(e),i=o.validateSIRET(e);if(!r&&!i)throw new n.default(e);const s=r?e:e.substr(0,9),c=t.getDataSources(),l=new t.EntrepriseModel({_dataSources:{}},t.EtablissementModel);for(let e=0;e<c.length;e++){const t=c[e].source;console.log(`Asking dataSource named ${c[e].name} about SIREN : ${s}`);const r=yield t.getSIREN(s),n=(0,u.cleanObject)(r);console.log(`Got response from dataSource named ${c[e].name} about SIREN : ${s}`),l.updateData(n),l.updateData({_dataSources:a({},l._dataSources,{[c[e].name]:!0})})}const d=i?e:""+l.siret_siege_social,f=Object.keys({[d]:!0,[l.siret_siege_social]:!0});for(let e=0;e<f.length;e++){const t=f[e];if(o.validateSIRET(t))for(let e=0;e<c.length;e++){const r=c[e].source;console.log(`Asking dataSource named ${c[e].name} about SIRET : ${t}`);const n=yield r.getSIRET(t),o=(0,u.cleanObject)(n);console.log(`Got response from dataSource named ${c[e].name} about SIRET : ${t}`),l.getEtablissement(t).updateData(o),l.getEtablissement(t).updateData({_dataSources:a({},l._dataSources,{[c[e].name]:!0})})}}return l})()}search(e){var t=this;return d(function*(){const r=t.getDataSources(),n={};for(let i=0;i<r.length;i++){const s=r[i].source,c=r[i].name;console.log(`Searching dataSource named ${c} with query: `,e);const l=yield s.search(e);!1!==l?Array.isArray(l)?(console.log(`Got response from dataSource named ${c} about query: `,e),l.forEach(function(e){const r=o.validateSIREN(e.siren)&&e.siren||e.siret.substr(0,9),i=o.validateSIRET(e.siret)&&e.siret;o.validateSIREN(r)&&(n[r]||(n[r]=new t.EntrepriseModel({siren:r,_dataSources:{}},t.EtablissementModel)),i?(n[r].getEtablissement(i).updateData((0,u.cleanObject)(e)),n[r].getEtablissement(i).updateData({_dataSources:a({},n[r].getEtablissement(i)._dataSources,{[c]:!0})})):n[r].updateData((0,u.cleanObject)(e)))})):console.error(`Source named ${c} returned invalid data for search, array expected. Received:`,l):console.log(`Source named ${c} doesn't support search. (it returned false)`)}return Object.values(n)})()}getDataSources(){return[...this[f]].sort((e,t)=>(e=+(e&&e.priority))>(t=+(t&&t.priority))?1:e<t?-1:0)}getDataSource(e){return this[f].find(t=>t.name===e)}addDataSource(e){this[f].includes(e)||this[f].push(e)}removeDataSource(e){this[f].slice(this[f].indexOf(e),1)}},e.exports.Entreprise=c.Entreprise,e.exports.Etablissement=c.Etablissement,e.exports.DataSource=s.default,e.exports.isSIRET=o.validateSIRET,e.exports.isSIREN=o.validateSIREN},function(e,t,r){e.exports=r(11)}])});