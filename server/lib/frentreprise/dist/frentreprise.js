!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("frentreprise",[],t):"object"==typeof exports?exports.frentreprise=t():e.frentreprise=t()}(global,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r.w={},r(r.s=11)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e};const a=Symbol("_importData"),s=Symbol("_data");t.default=class{constructor(e){this[a](e,!0)}updateData(e){this[a](e)}replaceData(e){this[a](e,!0)}[a](e,t=!1){"object"==typeof e&&(this[s]=n({},!0===t?{}:this[s],e)),Object.keys(this[s]).forEach(e=>{this.hasOwnProperty(e)||Object.defineProperty(this,e,{get:()=>this[s][e]})},this)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,a=r(5),s=(n=a)&&n.__esModule?n:{default:n};function i(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(a,s){try{var i=t[a](s),o=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}("next")})}}t.default=class{getSIRET(){return i(function*(){throw new s.default})()}getSIREN(){return i(function*(){throw new s.default})()}search(){return i(function*(){throw new s.default})()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,a=r(0),s=(n=a)&&n.__esModule?n:{default:n};t.default=class extends s.default{}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,a=r(0),s=(n=a)&&n.__esModule?n:{default:n};const i=Symbol("_ets");t.default=class extends s.default{constructor(e){super(e),this[i]=[]}get etablissements(){return[...this[i]]}importEtablissement(e){this[i].push(e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Etablissement=t.Entreprise=void 0;var n=r(3);Object.defineProperty(t,"Entreprise",{enumerable:!0,get:function(){return i(n).default}});var a=r(2);Object.defineProperty(t,"Etablissement",{enumerable:!0,get:function(){return i(a).default}});var s=i(n);function i(e){return e&&e.__esModule?e:{default:e}}t.default=s.default},function(e,t,r){"use strict";function n(e){const t=(new Error).stack.split("\n")[2].replace(" at ","");this.message=`The method ${t} isn't implemented.`,e&&(this.message+=` Message: "${e}".`);let r=this.message;for(;r.indexOf("  ")>-1;)r=r.replace("  "," ");this.message=r}Object.defineProperty(t,"__esModule",{value:!0}),n.prototype=Object.create(Error.prototype,{constructor:{value:n},name:{value:"NotImplementedError"},stack:{get:function(){return(new Error).stack}}}),t.default=n},function(e,t){e.exports=require("axios")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(r(6)),a=s(r(1));function s(e){return e&&e.__esModule?e:{default:e}}function i(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(a,s){try{var i=t[a](s),o=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}("next")})}}const o=Symbol("_getAPIParams"),c=Symbol("_convertDate"),l=Symbol("_getCleanAddress");t.default=class extends a.default{constructor(e){super(),this.token=null,this.axios=n.default.create({baseURL:e,timeout:3e4})}getSIRET(e){var t=this;return i(function*(){let r=null;try{r=yield t.axios.get(`etablissements_legacy/${e}`,{params:t[o](t)})}catch(e){console.error(e)}const n={};if(r&&"object"==typeof r&&r.data&&"object"==typeof r.data&&r.data.etablissement){const e=r.data.etablissement;["siret","siege_social","enseigne","nom_commercial","nom","prenom","siret_siege_social"].forEach(function(t){"boolean"==typeof e[t]?n[t]=e[t]:n[t]=e[t]||void 0}),e.etat_administratif&&"object"==typeof e.etat_administratif||(e.etat_administratif={}),n.etat_etablissement={label:e.etat_administratif_etablissement.value||"N/A",date:t[c](e.etat_administratif_etablissement.date_mise_a_jour)}}let a=null;try{a=yield t.axios.get(`etablissements/${e}`,{params:t[o](t)})}catch(e){console.log(e)}if(a&&"object"==typeof a&&a.data&&"object"==typeof a.data&&a.data.etablissement){const e=a.data.etablissement;[].forEach(function(t){n[t]=e[t]}),n.date_creation=t[c](e.date_creation_etablissement),e.adresse&&"object"==typeof e.adresse&&(n.adresse=t[l](e.adresse),n.adresse_components=e.adresse,n.departement="string"==typeof e.adresse.code_insee_localite&&e.adresse.code_insee_localite.length>1&&e.adresse.code_insee_localite.substr(0,2)),n.region=e.region_implementation&&e.region_implementation.value||void 0,n.activite=e.naf&&e.libelle_naf?`${e.naf} - ${e.libelle_naf}`:null,n.etablissement_employeur=+e.tranche_effectif_salarie_etablissement.a>0,n.tranche_effectif_insee=e.tranche_effectif_salarie_etablissement.intitule,n.annee_tranche_effectif_insee=+e.tranche_effectif_salarie_etablissement.date_reference||void 0}let s=null;try{s=yield t.axios.get(`attestations_agefiph/${e}`,{params:t[o](t)})}catch(e){console.log(e)}s&&"object"==typeof s&&s.data&&"object"==typeof s.data&&(n.agefiph_derniere_annee_conformite_connue=s.data.derniere_annee_de_conformite_connue||null);let i=null;try{i=yield t.axios.get(`exercices/${e}`,{params:t[o](t)})}catch(e){console.log(e)}return i&&"object"==typeof i&&i.data&&"object"==typeof i.data&&i.data.exercices&&Array.isArray(i.data.exercices)&&(n.donnees_ecofi={},i.data.exercices.forEach(function(e){n.donnees_ecofi[t[c](e.date_fin_exercice_timestamp).toISOString()]=+e.ca||null})),n})()}getSIREN(e){var t=this;return i(function*(){let r=null;try{r=yield t.axios.get(`entreprises_legacy/${e}`,{params:t[o](t)})}catch(e){console.log(e)}const n={};if(r&&"object"==typeof r&&r.data&&"object"==typeof r.data&&r.data.entreprise){const e=r.data.entreprise;["siren","raison_sociale","nombre_etablissements_actifs","nom_commercial","nom","prenom","siret_siege_social"].forEach(function(t){"boolean"==typeof e[t]?n[t]=e[t]:n[t]=e[t]||void 0}),n.categorie_juridique=e.forme_juridique,n.date_de_creation=t[c](e.date_creation),n.date_de_radiation=t[c](e.date_radiation),e.etat_administratif&&"object"==typeof e.etat_administratif||(e.etat_administratif={}),n.etat_entreprise={label:e.etat_administratif.value||"N/A",date:t[c](e.etat_administratif.date_mise_a_jour)}}let a=null;try{a=yield t.axios.get(`entreprises/${e}`,{params:t[o](t)})}catch(e){console.log(e)}if(a&&"object"==typeof a&&a.data&&"object"==typeof a.data&&a.data.entreprise){const e=a.data.entreprise;["categorie_entreprise"].forEach(function(t){n[t]=e[t]}),e.tranche_effectif_salarie_entreprise&&"object"==typeof e.tranche_effectif_salarie_entreprise&&(n.annee_tranche_effectif=+e.tranche_effectif_salarie_entreprise.date_reference||void 0,n.tranche_effectif=e.tranche_effectif_salarie_entreprise.intitule||void 0),Array.isArray(e.mandataires_sociaux)&&(n.mandataires_sociaux=[],e.mandataires_sociaux.forEach(function(e){n.mandataires_sociaux.push({nom:e.nom,prenom:e.prenom,fonction:e.fonction,raison_sociale:e.raison_sociale})}))}return n})()}[c](e){return e&&new Date(1e3*e)||void 0}[l](e){return`\n    ${e.numero_voie||""} ${e.type_voie||""} ${e.nom_voie||""}\n    ${e.complement_adresse||""} ${e.code_postal||""}\n    ${e.localite||""}\n    `.trim().split("\n").map(e=>e.trim()).join("\n")}[o](){return{token:this.token,context:"Tiers",recipient:"Direccte Occitanie",object:"FCEE - Direccte Occitanie"}}search(){return i(function*(){return!1})()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateSIREN=function(e){if(!/^[0-9]{9}$/.test(e))return!1;return e.split("").reduce((e,t,r)=>{t=+t;const n=r%2==0;return n?e+t:e+((t*=2)>9?t-9:t)},0)%10==0},t.validateSIRET=function(e){if(!/^[0-9]{14}$/.test(e))return!1;return e.split("").reduce((e,t,r)=>{t=+t;const n=r%2!=0;return n?e+t:e+((t*=2)>9?t-9:t)},0)%10==0}},function(e,t,r){"use strict";function n(e){this.message=`Invalid SIRET or SIREN. ${e}`}Object.defineProperty(t,"__esModule",{value:!0}),n.prototype=Object.create(Error.prototype,{constructor:{value:n},name:{value:"InvalidIdentifierError"},stack:{get:function(){return(new Error).stack}}}),t.default=n},function(e,t,r){"use strict";var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},a=l(r(9)),s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(r(8)),i=l(r(7)),o=l(r(1)),c=l(r(4));function l(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(a,s){try{var i=t[a](s),o=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}("next")})}}const f=Symbol("_dataSources"),d=Symbol("_cleanObject");e.exports=new class{constructor(){this.EntrepriseModel=c.default,this.EtablissementModel=c.default,this[f]=[],this.addDataSource({name:"ApiGouv",priority:100,source:new i.default("https://entreprise.api.gouv.fr/v2/")})}getEntreprise(e){var t=this;return u(function*(){e+="";const r=s.validateSIREN(e),i=s.validateSIRET(e);if(!r&&!i)throw new a.default(e);const o=r?e:e.substr(0,9),c=t.getDataSources();let l={_dataSources:{}};for(let e=0;e<c.length;e++){const r=c[e].source;(l=n({},l,t[d](yield r.getSIREN(o))))._dataSources[c[e].name]=!0}const u=new t.EntrepriseModel(l),f=i?e:""+u.siret_siege_social;if(s.validateSIRET(f)){let e={_dataSources:{}};for(let r=0;r<c.length;r++){const a=c[r].source;(e=n({},e,t[d](yield a.getSIRET(f))))._dataSources[c[r].name]=!0}u.importEtablissement(new t.EtablissementModel(e))}return u})()}search(e){var t=this;return u(function*(){const r=t.getDataSources(),a={};for(let i=0;i<r.length;i++){const o=r[i].source,c=r[i].name,l=yield o.search(e);!1!==l?Array.isArray(l)?l.forEach(function(e){const r=s.validateSIREN(e.siren)&&e.siren||e.siret.substr(0,9),i=s.validateSIRET(e.siret)&&e.siret;s.validateSIREN(r)&&(a[r]||(a[r]={siren:r,_dataSources:{}}),i?(Array.isArray(a[r].etablissements)||(a[r].etablissements={}),a[r].etablissements[i]=n({},a[r].etablissements[i]||{_dataSources:{}},t[d](e)),a[r].etablissements[i]._dataSources[c]=!0):(Array.isArray(e.etablissements)&&(e.etablissements=e.etablissements.reduce(function(e,t){s.validateSIRET(t.siret)&&(e[t.siret]=t)},{})),a[r].etablissements||(a[r].etablissements={}),Object.keys(e.etablissements||{}).forEach(function(s){a[r].etablissements[s]=n({},a[r].etablissements[s]||{_dataSources:{}},t[d](e.etablissements[s])),a[r].etablissements[s]._dataSources[c]=!0}),delete e.etablissements,a[r]=n({},a[r],t[d](e)),a[r]._dataSources[c]=!0))}):console.error(`Source named ${c} returned invalid data for search, array expected. Received:`,l):console.log(`Source named ${c} doesn't support search. (it returned false)`)}return Object.values(a).map(function(e){const r=Object.values(e.etablissements);delete e.etablissements,(r.length>0&&"string"!=typeof e.raison_sociale||e.raison_sociale.trim().length<1)&&(e.raison_sociale=r.map(function(e){return e.raison_sociale_entreprise}).filter(Boolean).reduce(function(e,t){return e||t},null));const n=new t.EntrepriseModel(e);return r.forEach(function(e){n.importEtablissement(new t.EtablissementModel(e))}),n})})()}[d](e){return Object.keys(e||{}).forEach(t=>{null!==e[t]&&void 0!==e[t]||delete e[t]}),e}getDataSources(){return[...this[f]].sort((e,t)=>(e=+(e&&e.priority))>(t=+(t&&t.priority))?1:e<t?-1:0)}getDataSource(e){return this[f].find(t=>t.name===e)}addDataSource(e){this[f].includes(e)||this[f].push(e)}removeDataSource(e){this[f].slice(this[f].indexOf(e),1)}},e.exports.Entreprise=c.default,e.exports.Etablissement=c.default,e.exports.DataSource=o.default,e.exports.isSIRET=s.validateSIRET,e.exports.isSIREN=s.validateSIREN},function(e,t,r){e.exports=r(10)}])});