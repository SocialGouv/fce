!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("frentreprise",[],t):"object"==typeof exports?exports.frentreprise=t():e.frentreprise=t()}(global,function(){return function(e){var t={};function a(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,a),n.l=!0,n.exports}return a.m=e,a.c=t,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},a.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a.w={},a(a.s=12)}([function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=a(1);Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})}),t.cleanObject=function(e){return Object.keys(e||{}).forEach(t=>{null!==e[t]&&void 0!==e[t]||delete e[t]}),e}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateSIREN=function(e){if(!/^[0-9]{9}$/.test(e))return!1;return e.split("").reduce((e,t,a)=>{t=+t;const r=a%2==0;return r?e+t:e+((t*=2)>9?t-9:t)},0)%10==0},t.validateSIRET=function(e){if(!/^[0-9]{14}$/.test(e))return!1;return e.split("").reduce((e,t,a)=>{t=+t;const r=a%2!=0;return r?e+t:e+((t*=2)>9?t-9:t)},0)%10==0}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e};const n=Symbol("_importData"),o=Symbol("_data");t.default=class{constructor(e={}){this[n](e,!0)}updateData(e){this[n](e)}replaceData(e){this[n](e,!0)}[n](e,t=!1){"object"==typeof e&&(this[o]=r({},!0===t?{}:this[o],e)),Object.keys(this[o]).forEach(e=>{this.hasOwnProperty(e)||Object.defineProperty(this,e,{get:()=>this[o][e]})},this)}};t._protected={_importData:n}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Etablissement=t.Entreprise=void 0;var r=a(6);Object.defineProperty(t,"Entreprise",{enumerable:!0,get:function(){return s(r).default}});var n=a(5);Object.defineProperty(t,"Etablissement",{enumerable:!0,get:function(){return s(n).default}});var o=s(r);function s(e){return e&&e.__esModule?e:{default:e}}t.default=o.default},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n=a(7),o=(r=n)&&r.__esModule?r:{default:r};function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){return function r(n,o){try{var s=t[n](o),i=s.value}catch(e){return void a(e)}if(!s.done)return Promise.resolve(i).then(function(e){r("next",e)},function(e){r("throw",e)});e(i)}("next")})}}t.default=class{getSIRET(){return s(function*(){throw new o.default})()}getSIREN(){return s(function*(){throw new o.default})()}search(){return s(function*(){throw new o.default})()}}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},o=a(2),s=(r=o)&&r.__esModule?r:{default:r},i=a(0);const c=Symbol("_entreprise");t.default=class extends s.default{constructor(e,t){super(),this[c]=t,this.replaceData(e)}[o._protected._importData](e){if(this[c]){const t=e&&e._etData;t&&"object"==typeof t&&(this[c].updateData((0,i.cleanObject)(t)),this[c].updateData({_dataSources:n({},this[c]._dataSources,e._dataSources)}),delete e._etData)}super[o._protected._importData](e)}}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=a(2),n=c(r),o=c(a(3)),s=a(1),i=a(0);function c(e){return e&&e.__esModule?e:{default:e}}const u=Symbol("_ets"),l=Symbol("_etsModel");t.default=class extends n.default{constructor(e,t=o.default){super(),this[u]=[],this[l]=t,this.replaceData(e)}[r._protected._importData](e,t){const a=e&&e._ets;a&&(Array.isArray(a)||(a=[a]),a.forEach(e=>{e&&"object"==typeof e&&(0,s.validateSIRET)(e.siret)&&this.getEtablissement(e.siret).updateData((0,i.cleanObject)(e))}),delete e._ets),super[r._protected._importData](e,t)}get etablissements(){return this[u]}hasEtablissement(e){return!!this.getEtablissement(e,!1)}getEtablissement(e,t=!0){return this[u].find(t=>t.siret===e)||t&&this[u].push(new this[l]({siret:e},this))&&this.getEtablissement(e)||null}}},function(e,t,a){"use strict";function r(e){const t=(new Error).stack.split("\n")[2].replace(" at ","");this.message=`The method ${t} isn't implemented.`,e&&(this.message+=` Message: "${e}".`);let a=this.message;for(;a.indexOf("  ")>-1;)a=a.replace("  "," ");this.message=a}Object.defineProperty(t,"__esModule",{value:!0}),r.prototype=Object.create(Error.prototype,{constructor:{value:r},name:{value:"NotImplementedError"},stack:{get:function(){return(new Error).stack}}}),t.default=r},function(e,t){e.exports=require("axios")},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=o(a(8)),n=o(a(4));function o(e){return e&&e.__esModule?e:{default:e}}function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){return function r(n,o){try{var s=t[n](o),i=s.value}catch(e){return void a(e)}if(!s.done)return Promise.resolve(i).then(function(e){r("next",e)},function(e){r("throw",e)});e(i)}("next")})}}const i=Symbol("_getAPIParams"),c=Symbol("_convertDate"),u=Symbol("_getCleanAddress");t.default=class extends n.default{constructor(e){super(),this.token=null,this.axios=r.default.create({baseURL:e,timeout:3e4})}getSIRET(e){var t=this;return s(function*(){let a=null;try{a=yield t.axios.get(`etablissements_legacy/${e}`,{params:t[i](t)})}catch(e){console.error(e)}const r={};if(a&&"object"==typeof a&&a.data&&"object"==typeof a.data&&a.data.etablissement){const e=a.data.etablissement;["siret","siege_social","enseigne","nom_commercial","nom","prenom","siret_siege_social"].forEach(function(t){"boolean"==typeof e[t]?r[t]=e[t]:r[t]=e[t]||void 0}),e.etat_administratif&&"object"==typeof e.etat_administratif||(e.etat_administratif={}),r.etat_etablissement={label:e.etat_administratif_etablissement.value||"N/A",date:t[c](e.etat_administratif_etablissement.date_mise_a_jour)}}let n=null;try{n=yield t.axios.get(`etablissements/${e}`,{params:t[i](t)})}catch(e){console.log(e)}if(n&&"object"==typeof n&&n.data&&"object"==typeof n.data&&n.data.etablissement){const e=n.data.etablissement;[].forEach(function(t){r[t]=e[t]}),r.date_creation=t[c](e.date_creation_etablissement),e.adresse&&"object"==typeof e.adresse&&(r.adresse=t[u](e.adresse),r.adresse_components=e.adresse,r.departement="string"==typeof e.adresse.code_insee_localite&&e.adresse.code_insee_localite.length>1&&e.adresse.code_insee_localite.substr(0,2)),r.code_region=e.region_implantation&&+e.region_implantation.code||0,r.region=e.region_implantation&&e.region_implantation.value||void 0,r.activite=e.naf&&e.libelle_naf?`${e.naf} - ${e.libelle_naf}`:null,r.etablissement_employeur=+e.tranche_effectif_salarie_etablissement.a>0,r.tranche_effectif_insee=e.tranche_effectif_salarie_etablissement.intitule,r.annee_tranche_effectif_insee=+e.tranche_effectif_salarie_etablissement.date_reference||void 0}let o=null;try{o=yield t.axios.get(`attestations_agefiph/${e}`,{params:t[i](t)})}catch(e){console.log(e)}o&&"object"==typeof o&&o.data&&"object"==typeof o.data&&(r.agefiph_derniere_annee_conformite_connue=o.data.derniere_annee_de_conformite_connue||null);let s=null;try{s=yield t.axios.get(`exercices/${e}`,{params:t[i](t)})}catch(e){console.log(e)}s&&"object"==typeof s&&s.data&&"object"==typeof s.data&&s.data.exercices&&Array.isArray(s.data.exercices)&&(r.donnees_ecofi={},s.data.exercices.forEach(function(e){r.donnees_ecofi[t[c](e.date_fin_exercice_timestamp).toISOString()]=+e.ca||null}));let l=null;try{l=yield t.axios.get(`associations/${e}`,{params:t[i](t)})}catch(e){console.log(e)}if(l&&"object"==typeof l&&l.data&&"object"==typeof l.data&&l.data.association&&"object"==typeof l.data.association&&l.data.association.etat&&(r.association=l.data.association),r.association){let a=null;try{a=yield t.axios.get(`documents_associations/${e}`,{params:t[i](t)})}catch(e){console.log(e)}if(a&&"object"==typeof a&&a.data&&"object"==typeof a.data&&Array.isArray(a.data.documents)){const e=a.data.documents.reduce(function(e,t){return"Statuts"===t.type&&+t.timestamp>+e.timestamp&&t||e},{timestamp:0});r.documents_associations=[e]}}return r})()}getSIREN(e){var t=this;return s(function*(){let a=null;try{a=yield t.axios.get(`entreprises_legacy/${e}`,{params:t[i](t)})}catch(e){console.log(e)}const r={};if(a&&"object"==typeof a&&a.data&&"object"==typeof a.data&&a.data.entreprise){const e=a.data.entreprise;["siren","raison_sociale","nombre_etablissements_actifs","nom_commercial","nom","prenom","siret_siege_social"].forEach(function(t){"boolean"==typeof e[t]?r[t]=e[t]:r[t]=e[t]||void 0}),r.categorie_juridique=e.forme_juridique,r.date_de_creation=t[c](e.date_creation),r.date_de_radiation=t[c](e.date_radiation),e.etat_administratif&&"object"==typeof e.etat_administratif||(e.etat_administratif={}),r.etat_entreprise={label:e.etat_administratif.value||"N/A",date:t[c](e.etat_administratif.date_mise_a_jour)}}let n=null;try{n=yield t.axios.get(`entreprises/${e}`,{params:t[i](t)})}catch(e){console.log(e)}if(n&&"object"==typeof n&&n.data&&"object"==typeof n.data&&n.data.entreprise){const e=n.data.entreprise;["categorie_entreprise"].forEach(function(t){r[t]=e[t]}),e.tranche_effectif_salarie_entreprise&&"object"==typeof e.tranche_effectif_salarie_entreprise&&(r.annee_tranche_effectif=+e.tranche_effectif_salarie_entreprise.date_reference||void 0,r.tranche_effectif=e.tranche_effectif_salarie_entreprise.intitule||void 0),Array.isArray(e.mandataires_sociaux)&&(r.mandataires_sociaux=[],e.mandataires_sociaux.forEach(function(e){r.mandataires_sociaux.push({nom:e.nom,prenom:e.prenom,fonction:e.fonction,raison_sociale:e.raison_sociale})}))}return r})()}[c](e){return e&&new Date(1e3*e)||void 0}[u](e){return`\n    ${e.numero_voie||""} ${e.type_voie||""} ${e.nom_voie||""}\n    ${e.complement_adresse||""} ${e.code_postal||""}\n    ${e.localite||""}\n    `.trim().split("\n").map(e=>e.trim()).join("\n")}[i](){return{token:this.token,context:"Tiers",recipient:"Direccte Occitanie",object:"FCEE - Direccte Occitanie"}}search(){return s(function*(){return!1})()}}},function(e,t,a){"use strict";function r(e){this.message=`Invalid SIRET or SIREN. ${e}`}Object.defineProperty(t,"__esModule",{value:!0}),r.prototype=Object.create(Error.prototype,{constructor:{value:r},name:{value:"InvalidIdentifierError"},stack:{get:function(){return(new Error).stack}}}),t.default=r},function(e,t,a){"use strict";var r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},n=l(a(10)),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t.default=e,t}(a(1)),s=l(a(9)),i=l(a(4)),c=a(3),u=a(0);function l(e){return e&&e.__esModule?e:{default:e}}function d(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){return function r(n,o){try{var s=t[n](o),i=s.value}catch(e){return void a(e)}if(!s.done)return Promise.resolve(i).then(function(e){r("next",e)},function(e){r("throw",e)});e(i)}("next")})}}const f=Symbol("_dataSources");e.exports=new class{constructor(){this.EntrepriseModel=c.Entreprise,this.EtablissementModel=c.Etablissement,this[f]=[],this.addDataSource({name:"ApiGouv",priority:100,source:new s.default("https://entreprise.api.gouv.fr/v2/")})}getEntreprise(e){var t=this;return d(function*(){e+="";const a=o.validateSIREN(e),s=o.validateSIRET(e);if(!a&&!s)throw new n.default(e);const i=a?e:e.substr(0,9),c=t.getDataSources(),l=new t.EntrepriseModel({_dataSources:{}},t.EtablissementModel);for(let e=0;e<c.length;e++){const t=c[e].source;console.log(`Asking dataSource named ${c[e].name} about SIREN : ${i}`);const a=yield t.getSIREN(i),n=(0,u.cleanObject)(a);console.log(`Got response from dataSource named ${c[e].name} about SIREN : ${i}`),l.updateData(n),l.updateData({_dataSources:r({},l._dataSources,{[c[e].name]:!0})})}const d=s?e:""+l.siret_siege_social,f=Object.keys({[d]:!0,[l.siret_siege_social]:!0});for(let e=0;e<f.length;e++){const t=f[e];if(o.validateSIRET(t))for(let e=0;e<c.length;e++){const a=c[e].source;console.log(`Asking dataSource named ${c[e].name} about SIRET : ${t}`);const n=yield a.getSIRET(t),o=(0,u.cleanObject)(n);console.log(`Got response from dataSource named ${c[e].name} about SIRET : ${t}`),l.getEtablissement(t).updateData(o),l.getEtablissement(t).updateData({_dataSources:r({},l._dataSources,{[c[e].name]:!0})})}}return l})()}search(e){var t=this;return d(function*(){const a=t.getDataSources(),n={};for(let s=0;s<a.length;s++){const i=a[s].source,c=a[s].name;console.log(`Searching dataSource named ${c} with query: `,e);const l=yield i.search(e);!1!==l?Array.isArray(l)?(console.log(`Got response from dataSource named ${c} about query: `,e),l.forEach(function(e){const a=o.validateSIREN(e.siren)&&e.siren||e.siret.substr(0,9),s=o.validateSIRET(e.siret)&&e.siret;o.validateSIREN(a)&&(n[a]||(n[a]=new t.EntrepriseModel({siren:a,_dataSources:{}},t.EtablissementModel)),s?(n[a].getEtablissement(s).updateData((0,u.cleanObject)(e)),n[a].getEtablissement(s).updateData({_dataSources:r({},n[a].getEtablissement(s)._dataSources,{[c]:!0})})):n[a].updateData((0,u.cleanObject)(e)))})):console.error(`Source named ${c} returned invalid data for search, array expected. Received:`,l):console.log(`Source named ${c} doesn't support search. (it returned false)`)}return Object.values(n)})()}getDataSources(){return[...this[f]].sort((e,t)=>(e=+(e&&e.priority))>(t=+(t&&t.priority))?1:e<t?-1:0)}getDataSource(e){return this[f].find(t=>t.name===e)}addDataSource(e){this[f].includes(e)||this[f].push(e)}removeDataSource(e){this[f].slice(this[f].indexOf(e),1)}},e.exports.Entreprise=c.Entreprise,e.exports.Etablissement=c.Etablissement,e.exports.DataSource=i.default,e.exports.isSIRET=o.validateSIRET,e.exports.isSIREN=o.validateSIREN},function(e,t,a){e.exports=a(11)}])});